## 课表查看器 — 知识库

版本：v2.0（存档日期：2025-09-01）

本文件是本项目的集中知识库，包含：项目概览、快速上手、导入/解析规则、UI 行为、代理（AI）解析说明、常见问题与故障排查步骤、以及开发者提示。

---

## 1 项目概览

- 名称：课表查看器（course-schedule-viewer）
- 目标：在浏览器端智能导入并展示高校/中学类Excel课表，支持按周筛选、日/周视图、移动端紧凑展示，以及可选的后端AI辅助解析。
- 技术栈：纯前端 HTML/CSS/JavaScript，使用 SheetJS (XLSX) 处理 Excel；部分附带 Python 脚本用于离线/批处理（可选）。

## 2 快速上手

1. 克隆仓库并在本地启动静态服务器：

   - 方法见根 README.md。推荐：`python -m http.server 8000`，然后打开 `http://localhost:8000`。

2. 打开页面后点击右上角“设置”打开设置与导入面板，使用“导入课表”按钮可选择多种文件类型（Excel/CSV/JSON/TXT/图片）。图片会通过已配置的后端 AI 代理进行识别与解析。

3. 导入后可使用周次选择器、日/周视图切换与搜索框查看课程。

## 3 代码与文件结构速览

- `index.html` — 主页面与控件
- `app.js` — 主要逻辑（导入、解析、渲染、UI 交互）
- `style.css` — 样式与响应式布局
- `courses_data.js` — 可选的示例课表数据
- `tmp_test_schedule.html` — 解析调试页面（用于粘贴可疑行并快速查看解析结果）
- `api/parse-excel.js` — 示例 serverless 代理（需部署）
- `README.md` — 项目总体说明

## 4 导入与解析流程（概念契约）

- 输入：用户上传的 Excel 文件（前端通过 SheetJS 读取为二维数组 `rows`）
- 处理：
  - `determineFileStructure`：预跳过明显标题/空行
  - `detectHeaders`：在前 20 行中寻找标题行并映射列（优先匹配中文/英文表头）
  - `parseDataRows`：逐行解析并调用 `parseTimeString` 处理“上课时间”字段
- 输出：标准化课程数组（每条记录包含 name, classId, time, location, teacher, weeks[], weekday, periods）

错误/返回模式：
- 成功：{ success: true, courses: [...], confidence: <number> }
- 失败或低置信度：{ success: false, message, errors: [...], warnings: [...] }

## 5 时间字符串解析规则（核心解析器说明）

解析器位置：`app.js` 中的 `parseTimeString` 与 `parseWeeks`。

支持项（常见格式）：
- 带周+星期+节次：`1-16周星期一3-4节`, `1-4,6-17周一3-4`
- 仅星期+节次：`星期二8-9节`
- 仅周次：`10周` 或 `1-5周`
- 多段并列：使用逗号或斜杠分隔，如 `1-4周/6-8周 周三 3-4节` 或 `1-4,6-7周 星期三 3-4节`

解析要点：
- 先做字符规范化（全角→半角，中文逗号/分号统一为英文逗号，去空格）
- 按逗号或斜杠分段，每段分别匹配模式；若未匹配则做宽松提取（数字/星期/节次）
- `parseWeeks` 会把范围 `2-4` 展开为 [2,3,4]。会清除浮点尾数（例如 `10.0`→`10`）并把周限定在 1..25

- 不同学校文件可能使用“单周/双周”或“周次后缀（odd/even）”标注，当前解析器未自动支持所有单双周语义；遇到此类情况可用 `tmp_test_schedule.html` 进行样例调试并手动清洗，或使用 AI 后端代理（见第7节)
注意事项与边界：
- 不同学校文件可能使用“单周/双周”或“周次后缀（odd/even）”标注，当前解析器未自动支持所有单双周语义；遇到此类情况可用 `tmp_test_schedule.html` 进行样例调试并手动清洗，或使用 AI 后端代理（见第7节)

新增文件类型支持：
- 本版本新增对 CSV/JSON/TXT 文件的导入支持（前端会将这些文本/表格转换为二维数组并使用相同的解析流程）。
- 对图片文件（如拍照的课表），前端会将图片上传到后端代理（需配置 `AI_PROXY_URL`），代理负责 OCR/格式识别并返回规范 JSON。前端不会直接在浏览器内执行 OCR，以避免高计算与兼容性问题。
- 不同学校文件可能使用“单周/双周”或“周次后缀（odd/even）”标注，当前解析器未自动支持所有单双周语义；遇到此类情况可用 `tmp_test_schedule.html` 进行样例调试并手动清洗，或使用 AI 后端代理（见第7节）

## 6 UI 行为与移动端说明

- 视图：支持“日视图”（当前或指定星期的详细列表）与“周视图”（一周 7 天的网格或卡片）
- 移动端模式：有两种移动展示模式（保存在 localStorage `MOBILE_VIEW_MODE`）：
  - `compact`：紧凑一屏网格，尽量在一屏显示整周（节次信息折叠，点击展开）
  - `scroll`：卡片滚动（横向/纵向，按设备宽度）
- 代理 URL：本地浏览器中保存键 `AI_PROXY_URL`（仅为方便前端在开发时指定已部署的后端代理）。

## 7 AI 后端代理（可选）

目的：在本地解析失败或置信度低时，把少量表格行发送到受信任的后端代理，由代理调用 AI（例如 OpenAI 或其他私有模型）来做复杂格式识别并返回规范 JSON。这样可避免在客户端暴露 API Key。

实现要点：
- 示例文件：`api/parse-excel.js`（为 serverless 环境写的小示例）
- 部署：推荐部署到 Vercel / Netlify / Cloudflare Workers 并在环境变量中保存 API_KEY
- 前端调用：POST 到 `${AI_PROXY_URL}/parse-excel`，载荷为 { fileName, rows }（前端会截取前 500 行以控制大小）
- 返回格式：同前面约定的 { success, courses, confidence, message }

安全注意：
- 不要把 AI key 写入前端代码。代理应仅向受信任的模型调用并对请求体大小作限制。

## 8 常见问题（FAQ）

Q: 导入后没有任何课程？
- 检查导入预览中的错误信息。常见原因：未能识别列标题（见 detectHeaders 日志）、时间字段为空或格式不支持。

Q: 某一条记录被拆成多条了？
- 因为原表存在多段时间字段（例如一门课在周一与周三均有）。解析器会将每个时间段拆成一条独立记录。可通过课程名称和 classId 合并展示。

Q: 出现“置信度较低，使用后端 AI 代理解析”？
- 表示自动检测到文件头或数据不够规范。你可以部署 `api/parse-excel.js` 并把其 URL 填入页面的代理设置，然后重试导入。

## 9 故障排查流程（调试步骤）

1. 打开浏览器控制台查看 `console.log` 输出（导入过程中会打印 header 检测与警告）
2. 使用 `tmp_test_schedule.html`：把出问题的“上课时间”行粘贴进去，点击解析，观察 `parseTimeString` 的输出
3. 若是列头检测失败，检查 Excel 首几行是否有 BOM、合并单元格或额外标题行；在 `detectHeaders` 中会尝试跳过标题或空行
4. 若遇到单/双周语义或复杂注释，考虑清洗来源 Excel 或使用 AI 代理进行少量示例解析
5. 若本地推送到 GitHub 出现 TLS/网络错误，检查系统级网络/代理设置并尝试切换 Git 的 TLS 后端（仅在受控环境下）或使用 SSH 方式推送

## 10 开发者提示（快速）

- 想添加对“单双周”支持：在 `parseTimeString` 中检测关键词（单周/双周/odd/even），然后基于 `parseWeeks` 返回的数组做筛选
- 增强列头识别：可在 `detectHeaders` 中加入更多候选模式或采用简单的 ML/字符串相似度匹配
- 为 AI 代理增加请求配额控制与示例缓存，减少费用

---

如果你希望我把这份知识库再细化为 README 的某个章节、生成一个可搜索的 JSON 索引，或把常见问题做成 issue 模板，我可以继续自动化这些改动。
